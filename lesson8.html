<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>第8課：單字朗讀練習</title>
  <style>
    body { font-family: 'Arial','Hiragino Kaku Gothic ProN','游ゴシック',sans-serif; background:#fff0f5; color:#333; padding:2rem; }
    header { display:grid; grid-template-columns: 1fr auto; gap:1rem; align-items:center; margin-bottom:.8rem; }
    h1 { color:#d26fa0; font-size:1.8rem; margin:0; }
    .controls { display:flex; flex-wrap:wrap; gap:.6rem .8rem; align-items:center; justify-content:flex-end; }

    .pill,.seg { background:#fff; border:1px solid #f0cde3; box-shadow:0 0 8px #e3a5c7; color:#c04583; }
    .pill { display:inline-flex; align-items:center; gap:.5rem; border-radius:999px; padding:.35rem .7rem; font-size:.95rem; user-select:none; }

    .pill input[type="checkbox"]{ width:46px; height:24px; appearance:none; outline:none; background:#f8d8e9; border-radius:999px; position:relative; cursor:pointer; transition:background .2s; }
    .pill input[type="checkbox"]::after{ content:""; position:absolute; width:20px; height:20px; top:2px; left:2px; background:#fff; border-radius:50%; box-shadow:0 1px 4px rgba(0,0,0,.2); transition:left .2s; }
    .pill input[type="checkbox"]:checked{ background:#ffaad4; }
    .pill input[type="checkbox"]:checked::after{ left:24px; }

    .search { border-radius:999px; padding:.4rem .8rem; display:inline-flex; align-items:center; gap:.5rem; }
    .search input { border:none; outline:none; background:transparent; min-width:12rem; color:#333; }

    .sliders { display:inline-flex; gap:.8rem; align-items:center; flex-wrap:wrap; border-radius:999px; padding:.4rem .8rem; font-size:.95rem; }
    .sliders label{ display:flex; align-items:center; gap:.4rem; }
    .sliders input[type="range"]{ width:120px; }

    /* Segmented control */
    .seg{ display:inline-flex; border-radius:999px; overflow:hidden; }
    .seg button{ border:none; background:transparent; padding:.45rem .9rem; cursor:pointer; color:#c04583; font-weight:600; }
    .seg button+button{ border-left:1px solid #f0cde3; }
    .seg button.active{ background:#ffaad4; color:#fff; }

    table { width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 0 12px #e3a5c7; }
    th, td { padding:0.8rem; text-align:left; border-bottom:1px solid #f0cde3; vertical-align:top; }
    th { background:#f8d8e9; color:#c04583; }
    td.jp:hover { cursor:pointer; background-color:#ffeaf5; }

    /* 假名顯示切換：隱藏 <rt> */
    .hide-kana rt { display:none; }
    ruby { ruby-position: under; }

    /* 單向練習模式（用 nth-child 直接隱藏整欄，免去逐格加 class） */
    /* 日→中（隱中文：第2、4欄） */
    .mode-cn th:nth-child(2), .mode-cn td:nth-child(2),
    .mode-cn th:nth-child(4), .mode-cn td:nth-child(4){ display:none; }
    /* 中→日（隱日文：第1、3欄） */
    .mode-jp th:nth-child(1), .mode-jp td:nth-child(1),
    .mode-jp th:nth-child(3), .mode-jp td:nth-child(3){ display:none; }

    .button-home{ margin-top:2rem; text-align:center; }
    .button-home a{ background:#ffaad4; color:#fff; padding:.8rem 1.5rem; text-decoration:none; border-radius:20px; font-weight:bold; box-shadow:0 4px 8px rgba(0,0,0,.1); }
    .button-home a:hover{ background:#f98fc3; }
  </style>
</head>
<body>
  <header>
    <h1>📘 第8課：單字＋例句朗讀練習</h1>
    <div class="controls">
      <label class="search pill" title="輸入以即時篩選（日/中皆可）">
        🔎 <input id="searchInput" type="text" placeholder="搜尋單字/意思/例句…"/>
      </label>
      <label class="pill" title="切換顯示/隱藏假名（ふりがな）">
        假名 <input id="kanaToggle" type="checkbox"/>
      </label>
      <div class="sliders pill" title="調整朗讀速度與音量（會記住偏好）">
        <label>速度 <input id="rate" type="range" min="0.6" max="1.6" step="0.1" value="1"/></label>
        <label>音量 <input id="volume" type="range" min="0" max="1" step="0.05" value="1"/></label>
      </div>
      <div class="seg" id="modeSeg" role="tablist" aria-label="練習模式">
        <button type="button" data-mode="both" class="active" aria-selected="true">顯示全部</button>
        <button type="button" data-mode="cn" aria-selected="false">日→中（隱中文）</button>
        <button type="button" data-mode="jp" aria-selected="false">中→日（隱日文）</button>
      </div>
    </div>
  </header>

  <table id="vocabTable">
    <tr>
      <th>單字（日文）</th>
      <th>中文意思</th>
      <th>例句（日文）</th>
      <th>中文翻譯</th>
    </tr>

    <!-- ====== 你的第8課資料，原封保留（略）。只示範前幾條，其他請照原本貼上 ====== -->
    <tr>
      <td class="jp" onclick="speakJP('ハンサム')">ハンサム</td>
      <td>英俊</td>
      <td class="jp" onclick="speakJP('かれは ハンサムです。')">かれは ハンサムです。</td>
      <td>他很英俊。</td>
    </tr>

    <tr>
      <td class="jp" onclick="speakJP('きれい')">きれい</td>
      <td>漂亮</td>
      <td class="jp" onclick="speakJP('にわは きれいです。')">にわは きれいです。</td>
      <td>庭院很漂亮。</td>
    </tr>

    <tr>
      <td class="jp" onclick="speakJP('しずか')"><ruby><rb>静</rb><rt>しず</rt></ruby>か（<span>な</span>）</td>
      <td>安靜</td>
      <td class="jp" onclick="speakJP('この へやは しずかです。')">この へやは しずかです。</td>
      <td>這個房間很安靜。</td>
    </tr>

    <!-- ……把你原本貼的所有 <tr> 內容繼續放在這裡即可（不需改動） …… -->

    <tr><td class="jp" onclick="speakJP('レストラン')">レストラン</td><td>餐廳</td><td class="jp" onclick="speakJP('レストランで ばんごはんを たべます。')">レストランで ばんごはんを たべます。</td><td>在餐廳吃晚餐。</td></tr>
  </table>

  <div class="button-home">
    <a href="index.html">回首頁 🏠</a>
  </div>

  <script>
    let voicesLoaded = false;

    // 偏好 keys（與第1課相同，方便全站共用）
    const KANA_KEY = 'showKana';
    const RATE_KEY = 'ttsRate';
    const VOL_KEY  = 'ttsVolume';
    const MODE_KEY = 'practiceMode';

    function getRate(){ const r = parseFloat(localStorage.getItem(RATE_KEY) ?? '1'); return isNaN(r)?1:r; }
    function getVolume(){ const v = parseFloat(localStorage.getItem(VOL_KEY) ?? '1'); return isNaN(v)?1:v; }

    // 語音（ja-JP）
    function speakJP(text){
      if(!voicesLoaded){
        window.speechSynthesis.onvoiceschanged = ()=>{ voicesLoaded = true; speakJP(text); };
        speechSynthesis.getVoices(); return;
      }
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'ja-JP';
      u.rate = getRate();
      u.volume = getVolume();
      const v = speechSynthesis.getVoices().find(v=>v.lang==='ja-JP');
      if(v) u.voice = v;
      speechSynthesis.speak(u);
    }

    // 假名切換
    function applyKanaPreference(show){
      document.body.classList.toggle('hide-kana', !show);
      const t = document.getElementById('kanaToggle'); if(t) t.checked = show;
    }

    // 練習模式
    function applyPracticeMode(mode){
      document.body.classList.remove('mode-cn','mode-jp');
      if(mode==='cn') document.body.classList.add('mode-cn');
      if(mode==='jp') document.body.classList.add('mode-jp');
      // segmented 狀態
      document.querySelectorAll('#modeSeg button').forEach(btn=>{
        const active = btn.dataset.mode===mode;
        btn.classList.toggle('active', active);
        btn.setAttribute('aria-selected', String(active));
      });
    }

    // 即時搜尋
    function setupSearch(){
      const input = document.getElementById('searchInput');
      const rows = Array.from(document.querySelectorAll('#vocabTable tr')).slice(1);
      input.addEventListener('input', ()=>{
        const q = input.value.trim().toLowerCase();
        rows.forEach(tr=>{
          const hit = tr.textContent.toLowerCase().includes(q);
          tr.style.display = hit ? '' : 'none';
        });
      });
    }

    // 讓所有日文欄的單元格（td.jp）可點擊朗讀
    function delegateSpeak(){
      document.addEventListener('click', e=>{
        const cell = e.target.closest('td.jp');
        if(!cell) return;
        const txt = cell.innerText.replace(/[（）\[\]]/g, '').trim();
        if(txt){
          speechSynthesis.cancel();
          setTimeout(()=>speakJP(txt), 80);
        }
      });
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      // 初始化語音
      const check = () => {
        if (speechSynthesis.getVoices().length > 0) voicesLoaded = true;
        else setTimeout(check, 120);
      }; check();

      // 假名偏好
      const savedKana = localStorage.getItem(KANA_KEY);
      const showKana = savedKana===null ? true : savedKana==='true';
      applyKanaPreference(showKana);
      document.getElementById('kanaToggle').addEventListener('change', e=>{
        const show = e.target.checked;
        applyKanaPreference(show);
        localStorage.setItem(KANA_KEY, String(show));
      });

      // TTS 偏好
      const rateEl = document.getElementById('rate');
      const volEl  = document.getElementById('volume');
      rateEl.value = String(getRate());
      volEl.value  = String(getVolume());
      rateEl.addEventListener('input', ()=> localStorage.setItem(RATE_KEY, rateEl.value));
      volEl.addEventListener('input',  ()=> localStorage.setItem(VOL_KEY,  volEl.value));

      // 練習模式
      const savedMode = localStorage.getItem(MODE_KEY) ?? 'both';
      applyPracticeMode(savedMode);
      document.querySelectorAll('#modeSeg button').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const mode = btn.dataset.mode;
          applyPracticeMode(mode);
          localStorage.setItem(MODE_KEY, mode);
        });
      });

      // 搜尋 + 點擊朗讀
      setupSearch();
      delegateSpeak();
    });
  </script>
</body>
</html>
